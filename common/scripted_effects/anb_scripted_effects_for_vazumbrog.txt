setup_gor_vazumbrog_variables = {
	set_variable = {
		which = gorVazumbrogHuntsCompleted
		value = 0
	}
	set_variable = {
		which = gorVazumbrogAdmOrderProvinces
		value = 0
	}
	set_variable = {
		which = gorVazumbrogDipOrderProvinces
		value = 0
	}
	set_variable = {
		which = gorVazumbrogMilOrderProvinces
		value = 0
	}
	set_variable = {
		which = gorVazumbrogArmyGolemFacilities
		value = 0
	}
	set_variable = {
		which = gorVazumbrogArmyGolemCapacity
		value = 0
	}
	set_variable = {
		which = gorVazumbrogWorkGolemFacilities
		value = 0
	}
	set_variable = {
		which = gorVazumbrogWorkGolemCapacity
		value = 0
	}
}

update_golem_workforce_modifier = {
	remove_country_modifier = gor_vazumbrog_work_golems_1
	remove_country_modifier = gor_vazumbrog_work_golems_2
	remove_country_modifier = gor_vazumbrog_work_golems_3
	remove_country_modifier = gor_vazumbrog_work_golems_4
	remove_country_modifier = gor_vazumbrog_work_golems_5
	remove_country_modifier = gor_vazumbrog_work_golems_6
	remove_country_modifier = gor_vazumbrog_work_golems_7
	remove_country_modifier = gor_vazumbrog_work_golems_8

	if = {
		limit = { check_variable = { gorVazumbrogWorkGolemFacilities = 8 } }
		add_country_modifier = { name = gor_vazumbrog_work_golems_8 duration = -1 }
	}
	else_if = {
		limit = { check_variable = { gorVazumbrogWorkGolemFacilities = 7 } }
		add_country_modifier = { name = gor_vazumbrog_work_golems_7 duration = -1 }
	}
	else_if = {
		limit = { check_variable = { gorVazumbrogWorkGolemFacilities = 6 } }
		add_country_modifier = { name = gor_vazumbrog_work_golems_6 duration = -1 }
	}
	else_if = {
		limit = { check_variable = { gorVazumbrogWorkGolemFacilities = 5 } }
		add_country_modifier = { name = gor_vazumbrog_work_golems_5 duration = -1 }
	}
	else_if = {
		limit = { check_variable = { gorVazumbrogWorkGolemFacilities = 4 } }
		add_country_modifier = { name = gor_vazumbrog_work_golems_4 duration = -1 }
	}
	else_if = {
		limit = { check_variable = { gorVazumbrogWorkGolemFacilities = 3 } }
		add_country_modifier = { name = gor_vazumbrog_work_golems_3 duration = -1 }
	}
	else_if = {
		limit = { check_variable = { gorVazumbrogWorkGolemFacilities = 2 } }
		add_country_modifier = { name = gor_vazumbrog_work_golems_2 duration = -1 }
	}
	else_if = {
		limit = { check_variable = { gorVazumbrogWorkGolemFacilities = 1 } }
		add_country_modifier = { name = gor_vazumbrog_work_golems_1 duration = -1 }
	}
}

update_army_golem_modifier = {
	remove_country_modifier = gor_vazumbrog_army_golems_1
	remove_country_modifier = gor_vazumbrog_army_golems_2
	remove_country_modifier = gor_vazumbrog_army_golems_3
	remove_country_modifier = gor_vazumbrog_army_golems_4
	remove_country_modifier = gor_vazumbrog_army_golems_5
	remove_country_modifier = gor_vazumbrog_army_golems_6
	remove_country_modifier = gor_vazumbrog_army_golems_7
	remove_country_modifier = gor_vazumbrog_army_golems_8
	remove_country_modifier = gor_vazumbrog_army_golems_9
	remove_country_modifier = gor_vazumbrog_army_golems_10
	remove_country_modifier = gor_vazumbrog_army_golems_11
	remove_country_modifier = gor_vazumbrog_army_golems_12
	remove_country_modifier = gor_vazumbrog_army_golem_quality_1
	remove_country_modifier = gor_vazumbrog_army_golem_quality_2
	remove_country_modifier = gor_vazumbrog_army_golem_quality_3
	remove_country_modifier = gor_vazumbrog_army_golem_quality_4
	remove_country_modifier = gor_vazumbrog_army_golem_quality_5
	remove_country_modifier = gor_vazumbrog_army_golem_quality_6
	remove_country_modifier = gor_vazumbrog_army_golem_quality_7
	remove_country_modifier = gor_vazumbrog_army_golem_quality_8
	remove_country_modifier = gor_vazumbrog_army_golem_quality_9
	remove_country_modifier = gor_vazumbrog_army_golem_quality_10
	remove_country_modifier = gor_vazumbrog_army_golem_quality_11
	remove_country_modifier = gor_vazumbrog_army_golem_quality_12

	if = {
		limit = { check_variable = { gorVazumbrogArmyGolemFacilities = 12 } }
		add_country_modifier = { name = gor_vazumbrog_army_golems_12 duration = -1 }
		add_country_modifier = { name = gor_vazumbrog_army_golem_quality_12 duration = -1 }
	}
	else_if = {
		limit = { check_variable = { gorVazumbrogArmyGolemFacilities = 11 } }
		add_country_modifier = { name = gor_vazumbrog_army_golems_11 duration = -1 }
		add_country_modifier = { name = gor_vazumbrog_army_golem_quality_11 duration = -1 }
	}
	else_if = {
		limit = { check_variable = { gorVazumbrogArmyGolemFacilities = 10 } }
		add_country_modifier = { name = gor_vazumbrog_army_golems_10 duration = -1 }
		add_country_modifier = { name = gor_vazumbrog_army_golem_quality_10 duration = -1 }
	}
	else_if = {
		limit = { check_variable = { gorVazumbrogArmyGolemFacilities = 9 } }
		add_country_modifier = { name = gor_vazumbrog_army_golems_9 duration = -1 }
		add_country_modifier = { name = gor_vazumbrog_army_golem_quality_9 duration = -1 }
	}
	else_if = {
		limit = { check_variable = { gorVazumbrogArmyGolemFacilities = 8 } }
		add_country_modifier = { name = gor_vazumbrog_army_golems_8 duration = -1 }
		add_country_modifier = { name = gor_vazumbrog_army_golem_quality_8 duration = -1 }
	}
	else_if = {
		limit = { check_variable = { gorVazumbrogArmyGolemFacilities = 7 } }
		add_country_modifier = { name = gor_vazumbrog_army_golems_7 duration = -1 }
		add_country_modifier = { name = gor_vazumbrog_army_golem_quality_7 duration = -1 }
	}
	else_if = {
		limit = { check_variable = { gorVazumbrogArmyGolemFacilities = 6 } }
		add_country_modifier = { name = gor_vazumbrog_army_golems_6 duration = -1 }
		add_country_modifier = { name = gor_vazumbrog_army_golem_quality_6 duration = -1 }
	}
	else_if = {
		limit = { check_variable = { gorVazumbrogArmyGolemFacilities = 5 } }
		add_country_modifier = { name = gor_vazumbrog_army_golems_5 duration = -1 }
		add_country_modifier = { name = gor_vazumbrog_army_golem_quality_5 duration = -1 }
	}
	else_if = {
		limit = { check_variable = { gorVazumbrogArmyGolemFacilities = 4 } }
		add_country_modifier = { name = gor_vazumbrog_army_golems_4 duration = -1 }
		add_country_modifier = { name = gor_vazumbrog_army_golem_quality_4 duration = -1 }
	}
	else_if = {
		limit = { check_variable = { gorVazumbrogArmyGolemFacilities = 3 } }
		add_country_modifier = { name = gor_vazumbrog_army_golems_3 duration = -1 }
		add_country_modifier = { name = gor_vazumbrog_army_golem_quality_3 duration = -1 }
	}
	else_if = {
		limit = { check_variable = { gorVazumbrogArmyGolemFacilities = 2 } }
		add_country_modifier = { name = gor_vazumbrog_army_golems_2 duration = -1 }
		add_country_modifier = { name = gor_vazumbrog_army_golem_quality_2 duration = -1 }
	}
	else_if = {
		limit = { check_variable = { gorVazumbrogArmyGolemFacilities = 1 } }
		add_country_modifier = { name = gor_vazumbrog_army_golems_1 duration = -1 }
		add_country_modifier = { name = gor_vazumbrog_army_golem_quality_1 duration = -1 }
	}
}

dauvek_veker_action_secure_road = {
	if = {
		limit = {
			NOT = {
				any_hired_mercenary_company = {
					template = merc_dauvek_veker
				}
			}
		}
		custom_tooltip = GV_TT_DAUVEK_VEKER_NOT_HIRED
	}
	else = {
		if = {
			limit = {
				any_hired_mercenary_company = {
					template = merc_dauvek_veker
					location = {
						unit_in_battle = yes
					}
				}
			}
			custom_tooltip = GV_TT_MERC_BUSY_FIGHTING
		}
		else_if = {
			limit = {
				any_hired_mercenary_company = {
					template = merc_dauvek_veker
					location = {
						OR = {
							is_city = yes
							NOT = { owned_by = ROOT }
							NOT = { controlled_by = ROOT }
						}
					}
				}
			}
			custom_tooltip = GV_TT_MERC_NOT_IN_OUR_COLONY
		}
		else_if = {
			limit = {
				any_hired_mercenary_company = {
					template = merc_dauvek_veker
					location = {
						NOT = { has_terrain = dwarven_road }
					}
				}
			}
			custom_tooltip = GV_TT_MERC_NOT_IN_DWARVEN_ROAD
		}
		else = {
			custom_tooltip = GV_TT_SECURE_TUNNELS_ABILITY_DESC
			custom_tooltip = " "

			random_hired_mercenary_company = {
				limit = { template = merc_dauvek_veker }

				location = {
					add_permanent_province_modifier = {
						name = gor_vazumbrog_dauvek_veker_secure_road
						duration = -1
					}
				}

				disband_mercenary_company = THIS
			}

			set_country_flag = gor_vazumbrog_dauvek_veker_mercenaries_disabled
			add_dip_power = -20
			clr_country_flag = gor_vazumbrog_dauvek_veker_menu_open
		}
	}
}

dauvek_veker_secure_road_colony_finished = {
	remove_province_modifier = gor_vazumbrog_dauvek_veker_secure_road
	owner = { clr_country_flag = gor_vazumbrog_dauvek_veker_mercenaries_disabled }
}

dauvek_veker_action_clear_cave = {
	if = {
		limit = {
			NOT = {
				any_hired_mercenary_company = {
					template = merc_dauvek_veker
				}
			}
		}
		custom_tooltip = GV_TT_DAUVEK_VEKER_NOT_HIRED
	}
	else = {
		if = {
			limit = {
				any_hired_mercenary_company = {
					template = merc_dauvek_veker
					location = {
						unit_in_battle = yes
					}
				}
			}
			custom_tooltip = GV_TT_MERC_BUSY_FIGHTING
		}
		else_if = {
			limit = {
				any_hired_mercenary_company = {
					template = merc_dauvek_veker
					location = {
						OR = {
							is_city = yes
							NOT = { owned_by = ROOT }
							NOT = { controlled_by = ROOT }
						}
					}
				}
			}
			custom_tooltip = GV_TT_MERC_NOT_IN_OUR_COLONY
		}
		else_if = {
			limit = {
				any_hired_mercenary_company = {
					template = merc_dauvek_veker
					location = {
						NOT = { has_terrain = cavern }
					}
				}
			}
			custom_tooltip = GV_TT_MERC_NOT_IN_CAVERN
		}
		else = {
			custom_tooltip = GV_TT_CLEAR_CAVE_ABILITY_DESC
			custom_tooltip = " "

			random_hired_mercenary_company = {
				limit = { template = merc_dauvek_veker }

				hidden_effect = {
					add_company_manpower = -0.2
				}
				location = {
					add_province_modifier = {
						name = gor_vazumbrog_dauvek_veker_caves_cleared
						duration = -1
					}

					hidden_effect = {
						change_native_ferocity = -50
					}
				}

				disband_mercenary_company = THIS
			}

			add_mil_power = -20
			clr_country_flag = gor_vazumbrog_dauvek_veker_menu_open
		}
	}
}

dauvek_veker_action_produce_shadowweave_cloaks = {
	if = {
		limit = {
			NOT = {
				any_hired_mercenary_company = {
					template = merc_dauvek_veker
				}
			}
		}
		custom_tooltip = GV_TT_DAUVEK_VEKER_NOT_HIRED
	}
	else_if = {
		limit = {
			any_hired_mercenary_company = {
				template = merc_dauvek_veker
				location = {
					unit_in_battle = yes
				}
			}
		}
		custom_tooltip = GV_TT_MERC_BUSY_FIGHTING
	}
	else_if = {
		limit = {
			NOT = {
				num_of_owned_provinces_with = {
					value = 2
					trade_goods = silk
				}
			}
		}
		custom_tooltip = GV_TT_MERC_NOT_ENOUGH_SILK_PROVINCES
	}
	else_if = {
		limit = {
			any_hired_mercenary_company = {
				template = merc_dauvek_veker
				location = {
					NOT = { trade_goods = silk }
				}
			}
		}
		custom_tooltip = GV_TT_MERC_NOT_ON_SILK_PROVINCE
	}
	else = {
		every_owned_province = {
			limit = { trade_goods = silk }
			add_province_modifier = {
				name = gor_vazumbrog_silk_production_diverted
				duration = 365
			}
		}
		set_country_flag = vault_shadowweave_cloaks_produced
		custom_tooltip = GV_TT_SHADOWWEAVE_SCOUTS_UNLOCKED
		clr_country_flag = gor_vazumbrog_dauvek_veker_menu_open

	}


}
dauvek_veker_action_shadowweave_scouts = {
	if = {
		limit = {
			any_hired_mercenary_company = {
				template = merc_dauvek_veker
				location = {
					NOT = { unit_in_battle = yes }
					any_neighbor_province = {
						owner = {
							NOT = { tag = I14 }
							NOT = { is_subject_of = I14 }
							NOT = { gives_military_access_to = I14 }
						}
					}
				}
			}
		}
		custom_tooltip = GV_TT_SHADOWWEAVE_SCOUTS_ABILITY_DESC
		custom_tooltip = " "

		random_hired_mercenary_company = {
			limit = { template = merc_dauvek_veker }
			location = {
				random_neighbor_province = {
					limit = {
						owner = {
							NOT = { tag = I14 }
							NOT = { is_subject_of = I14 }
							NOT = { gives_military_access_to = I14 }
						}
					}
					mercenary_infantry = I14
					hidden_effect = { discover_country = ROOT }
				}
			}

			hidden_effect = {
				add_company_manpower = -0.15
				disband_mercenary_company = THIS
			}
		}

		set_country_flag = gor_vazumbrog_shadowweave_scouts_active
		add_country_modifier = {
			name = gor_vazumbrog_shadowweave_scouts
			duration = 500
		}

		clr_country_flag = gor_vazumbrog_dauvek_veker_menu_open

		hidden_effect = {
			country_event = {
				id = flavour_gor_vazumbrog.602
				days = 30
			}
		}
	}
	else_if = {
		limit = {
			NOT = {
				any_hired_mercenary_company = {
					template = merc_dauvek_veker
				}
			}
		}
		custom_tooltip = GV_TT_DAUVEK_VEKER_NOT_HIRED
	}
	else_if = {
		limit = {
			any_hired_mercenary_company = {
				template = merc_dauvek_veker
				location = {
					unit_in_battle = yes
				}
			}
		}
		custom_tooltip = GV_TT_MERC_BUSY_FIGHTING
	}
	else_if = {
		limit = {
			any_hired_mercenary_company = {
				template = merc_dauvek_veker
				location = {
					NOT = {
						any_neighbor_province = {
							owner = {
								NOT = { tag = I14 }
								NOT = { is_subject_of = I14 }
								NOT = { gives_military_access_to = I14 }
							}
						}
					}
				}
			}
		}
		custom_tooltip = GV_TT_MERC_NOT_BORDERING_INACCESSIBLE_PROVINCE
	}
}

gor_vazumbrog_give_cb_for_hold = {
	if = {
		limit = { # No CB if already ours
			NOT = { $province_id$ = { country_or_subject_holds = ROOT } }
		}
		if = {
			limit = {
				$province_id$ = { is_city = yes }
				OR = {
					NOT = { exists = $tag$ }
					NOT = { $province_id$ = { owned_by = $tag$ } }
					$tag$ = {
						# only monarchies are supported for cb_restore_personal_union, so others should get cb_reclaim_hold instead
						is_subject = no
						NOT = { government = monarchy }
					}
				}
			}

			$province_id$ = { set_province_flag = reclaim_hold_target_province }

			hidden_effect = {
				$province_id$ = {
					owner = {
						save_event_target_as = hold_owner
					}
				}
			}

			add_casus_belli = {
				type = cb_reclaim_hold
				target = event_target:hold_owner
				months = 1200
			}
			custom_tooltip = cb_reclaim_hold_tooltip
		}
		if = {
			limit = {
				exists = $tag$
				$province_id$ = {
					is_city = yes
					owned_by = $tag$
				}
				$tag$ = {
					is_subject = no
					government = monarchy
				}
			}
			add_casus_belli = {
				type = cb_restore_personal_union
				target = $tag$
				months = 1200
			}
		}
		if = {
			limit = {
				OR = {
					$province_id$ = { is_city = no }
					$tag$ = { is_subject = yes } # someone elses subject
				}
			}
			$province_id$ = { add_permanent_claim = ROOT }
		}
	}
}

#THIS and FROM scope is country losing the war and releasing the hold
#ROOT scope is the country winning the war
gor_vazumbrog_restore_hold = {
	# cede provinces to the new hold if needed
	if = {
		limit = {
			NOT = { tag = $released_tag$ }
			owns = $hold_province$
		}

		# take the area around the hold
		$hold_province$ = {
			area = {
				limit = {
					OR = {
						owned_by = FROM
						owned_by_subject_of = FROM
					}
				}
				cede_province = $released_tag$
				add_core = $released_tag$
			}
		}

		# also take every owned serpentspine road
		every_owned_province = {
			limit = { has_terrain = dwarven_road }
			cede_province = $released_tag$
		}

		every_subject_country = {
			every_owned_province = {
				limit = { has_terrain = dwarven_road }
				cede_province = $released_tag$
			}
		}

		$released_tag$ = {
			add_opinion = {
				who = ROOT
				modifier = released_in_peace
			}
		}
	}

	# next, set up the new tag
	if = {
		limit = {
			$released_tag$ = { owns = $hold_province$ } # safeguard in case some shenanigans happened during the war
		}
		$released_tag$ = {
			if = {
				limit = { NOT = { capital = $hold_province$ } }
				set_capital = $hold_province$
			}

			if = {
				limit = { NOT = { government = monarchy } }
				change_government = monarchy
			}
			add_government_reform = dwarovar_dwarven_clan_reform

			change_primary_culture = $culture$
			change_religion = ROOT

			if = {
				limit = {
					any_owned_province = {
						fast_has_pop_of_race { race = goblin }
					}
				}
				generic_start_purge = { race = goblin free = yes }
			}

			if = {
				limit = {
					any_owned_province = {
						fast_has_pop_of_race { race = orcish }
					}
				}
				generic_start_purge = { race = orcish free = yes }
			}

			$hold_province$ = {
				area = {
					limit = { owned_by = $released_tag$ }
					change_culture = $culture$
					change_religion = ROOT
				}
				clr_province_flag = reclaim_hold_target_province
			}
		}
		ROOT = {
			create_subject = {
				subject_type = personal_union
				subject = $released_tag$
			}
		}
	}

	# push non-serpentspine nation out of the serpentspine
	if = {
		limit = {
			capital_scope = {
				NOT = { continent = serpentspine }
			}
		}
		every_owned_province = {
			limit = { continent = serpentspine }
			cede_province = ---
			random_list = {
				20 = {
					change_native_size = 4
					change_native_hostileness = 7
					change_native_ferocity = 6
				}
				20 = {
					change_native_size = 5
					change_native_hostileness = 5
					change_native_ferocity = 6
				}
				20 = {
					change_native_size = 6
					change_native_hostileness = 4
					change_native_ferocity = 5
				}
				20 = {
					change_native_size = 7
					change_native_hostileness = 5
					change_native_ferocity = 4
				}
				20 = {
					change_native_size = 8
					change_native_hostileness = 4
					change_native_ferocity = 4
				}
			}
		}
	}
}

gor_vazumbrog_update_citadels_upgraded = {
	if = {
		limit = { has_country_flag = gor_vazumbrog_citadel_bonus_defensiveness }
		gor_vazumbrog_update_citadels_placement = { level = upgraded bonus = defensiveness }
	}
	else_if = {
		limit = { has_country_flag = gor_vazumbrog_citadel_bonus_attrition }
		gor_vazumbrog_update_citadels_placement = { level = upgraded bonus = attrition }
	}
	else_if = {
		limit = { has_country_flag = gor_vazumbrog_citadel_bonus_counterattack }
		gor_vazumbrog_update_citadels_placement = { level = upgraded bonus = counterattack }
	}
	else_if = {
		limit = { has_country_flag = gor_vazumbrog_citadel_bonus_garrison }
		gor_vazumbrog_update_citadels_placement = { level = upgraded bonus = garrison }
	}
	else = {
		gor_vazumbrog_update_citadels_placement = { level = upgraded bonus = none }
	}
}

gor_vazumbrog_update_citadels_level = {
	if = {
		limit = { has_country_flag = gor_vazumbrog_powerful_arm_of_krummul }
		gor_vazumbrog_update_citadels_placement = { level = upgraded bonus = $bonus$}
	}
	else = {
		gor_vazumbrog_update_citadels_placement = { level = basic bonus = $bonus$}
	}
}

gor_vazumbrog_update_citadels_placement = {
	if = {
		limit = { 2884 = { has_province_flag = citadel_province } }
		gor_vazumbrog_remove_citadel_modifiers = { PROVINCE = 2884 citadel = bogig_vazumbrog }
		gor_vazumbrog_update_citadel_province = {
			PROVINCE = 2884
			citadel = bogig_vazumbrog
			level = $level$
			bonus = $bonus$
		}
	}
	if = {
		limit = { 2878 = { has_province_flag = citadel_province } }
		gor_vazumbrog_remove_citadel_modifiers = { PROVINCE = 2878 citadel = mushroom }
		gor_vazumbrog_update_citadel_province = {
			PROVINCE = 2878
			citadel = mushroom
			level = $level$
			bonus = $bonus$
		}
	}
	if = {
		limit = { 7024 = { has_province_flag = citadel_province } }
		gor_vazumbrog_remove_citadel_modifiers = { PROVINCE = 7024 citadel = forest }
		gor_vazumbrog_update_citadel_province = {
			PROVINCE = 7024
			citadel = forest
			level = $level$
			bonus = $bonus$
		}
	}
	if = {
		limit = { 4242 = { has_province_flag = citadel_province } }
		gor_vazumbrog_remove_citadel_modifiers = { PROVINCE = 4242 citadel = bogig_ozumbrog }
		gor_vazumbrog_update_citadel_province = {
			PROVINCE = 4242
			citadel = bogig_ozumbrog
			level = $level$
			bonus = $bonus$
		}
	}
	if = {
		limit = { 647 = { has_province_flag = citadel_province } }
		gor_vazumbrog_remove_citadel_modifiers = { PROVINCE = 647 citadel = desert }
		gor_vazumbrog_update_citadel_province = {
			PROVINCE = 647
			citadel = desert
			level = $level$
			bonus = $bonus$
		}
	}
	if = {
		limit = { 670 = { has_province_flag = citadel_province } }
		gor_vazumbrog_remove_citadel_modifiers = { PROVINCE = 670 citadel = outer }
		gor_vazumbrog_update_citadel_province = {
			PROVINCE = 670
			citadel = outer
			level = $level$
			bonus = $bonus$
		}
	}
	if = {
		limit = { 2980 = { has_province_flag = citadel_province } }
		gor_vazumbrog_remove_citadel_modifiers = { PROVINCE = 2980 citadel = outer }
		gor_vazumbrog_update_citadel_province = {
			PROVINCE = 2980
			citadel = outer
			level = $level$
			bonus = $bonus$
		}
	}
	if = {
		limit = { 4250 = { has_province_flag = citadel_province } }
		gor_vazumbrog_remove_citadel_modifiers = { PROVINCE = 4250 citadel = outer }
		gor_vazumbrog_update_citadel_province = {
			PROVINCE = 4250
			citadel = outer
			level = $level$
			bonus = $bonus$
		}
	}
}

gor_vazumbrog_remove_citadel_modifiers = {
	$PROVINCE$ = {
		remove_province_modifier = gor_vazumbrog_citadel_$citadel$_basic_none
		remove_province_modifier = gor_vazumbrog_citadel_$citadel$_basic_defensiveness
		remove_province_modifier = gor_vazumbrog_citadel_$citadel$_basic_attrition
		remove_province_modifier = gor_vazumbrog_citadel_$citadel$_basic_counterattack
		remove_province_modifier = gor_vazumbrog_citadel_$citadel$_basic_garrison
		remove_province_modifier = gor_vazumbrog_citadel_$citadel$_upgraded_none
		remove_province_modifier = gor_vazumbrog_citadel_$citadel$_upgraded_defensiveness
		remove_province_modifier = gor_vazumbrog_citadel_$citadel$_upgraded_attrition
		remove_province_modifier = gor_vazumbrog_citadel_$citadel$_upgraded_counterattack
		remove_province_modifier = gor_vazumbrog_citadel_$citadel$_upgraded_garrison
	}
}

gor_vazumbrog_update_citadel_province = {
	# Usage: make sure to remove other modifiers first, gor_vazumbrog_remove_citadel_modifiers = { PROVINCE = ... citadel = ... }
	$PROVINCE$ = {
		add_permanent_province_modifier = {
			name = gor_vazumbrog_citadel_$citadel$_$level$_$bonus$
			duration = -1
		}
	}
}

gor_vazumbrog_build_citadel = {
	$province$ = {
		set_province_flag = citadel_province
		if = {
			limit = { continent = serpentspine }
			change_culture = ROOT
			change_religion = ROOT
		}
		else = {
			add_dwarven_minority_size_effect = yes
			add_dwarven_minority_size_effect = yes
		}
	}
	# input: province and citadel type
	# check for level and bonus
	if = {
		limit = { has_country_flag = gor_vazumbrog_citadel_bonus_defensiveness }
		if = {
			limit = { has_country_flag = gor_vazumbrog_powerful_arm_of_krummul }
			gor_vazumbrog_update_citadel_province = {
				PROVINCE = $province$
				citadel = $citadel$
				level = upgraded
				bonus = defensiveness
			}
		}
		else = {
			gor_vazumbrog_update_citadel_province = {
				PROVINCE = $province$
				citadel = $citadel$
				level = basic
				bonus = defensiveness
			}
		}
	}
	else_if = {
		limit = { has_country_flag = gor_vazumbrog_citadel_bonus_attrition }
		if = {
			limit = { has_country_flag = gor_vazumbrog_powerful_arm_of_krummul }
			gor_vazumbrog_update_citadel_province = {
				PROVINCE = $province$
				citadel = $citadel$
				level = upgraded
				bonus = attrition
			}
		}
		else = {
			gor_vazumbrog_update_citadel_province = {
				PROVINCE = $province$
				citadel = $citadel$
				level = basic
				bonus = attrition
			}
		}
	}
	else_if = {
		limit = { has_country_flag = gor_vazumbrog_citadel_bonus_counterattack }
		if = {
			limit = { has_country_flag = gor_vazumbrog_powerful_arm_of_krummul }
			gor_vazumbrog_update_citadel_province = {
				PROVINCE = $province$
				citadel = $citadel$
				level = upgraded
				bonus = counterattack
			}
		}
		else = {
			gor_vazumbrog_update_citadel_province = {
				PROVINCE = $province$
				citadel = $citadel$
				level = basic
				bonus = counterattack
			}
		}
	}
	else_if = {
		limit = { has_country_flag = gor_vazumbrog_citadel_bonus_garrison }
		if = {
			limit = { has_country_flag = gor_vazumbrog_powerful_arm_of_krummul }
			gor_vazumbrog_update_citadel_province = {
				PROVINCE = $province$
				citadel = $citadel$
				level = upgraded
				bonus = garrison
			}
		}
		else = {
			gor_vazumbrog_update_citadel_province = {
				PROVINCE = $province$
				citadel = $citadel$
				level = basic
				bonus = garrison
			}
		}
	}
	else = {
		if = {
			limit = { has_country_flag = gor_vazumbrog_powerful_arm_of_krummul }
			gor_vazumbrog_update_citadel_province = {
				PROVINCE = $province$
				citadel = $citadel$
				level = upgraded
				bonus = none
			}
		}
		else = {
			gor_vazumbrog_update_citadel_province = {
				PROVINCE = $province$
				citadel = $citadel$
				level = basic
				bonus = none
			}
		}
	}
}

gor_vazumbrog_finished_hunt = {
	hidden_effect = {
		change_variable = { gorVazumbrogHuntsCompleted = 1 }
		set_country_flag = $quarry$_hunt_completed

		if = {
			limit = {
				any_hired_mercenary_company = {
					template = merc_dauvek_veker
					location = { NOT = { owned_by = ROOT } }
				}
			}
			random_hired_mercenary_company = {
				limit = { template = merc_dauvek_veker }
				add_company_manpower = -0.1
				disband_mercenary_company = THIS
			}
		}

		if = {
			limit = {
				any_province = {
					gor_vazumbrog_shadowweave_scouts_province = yes
				}
			}
			random_province = {
				limit = { gor_vazumbrog_shadowweave_scouts_province = yes }
				kill_units = { who = ROOT }
			}
			clr_country_flag = gor_vazumbrog_shadowweave_scouts_active
			remove_country_modifier = gor_vazumbrog_shadowweave_scouts
		}

		if = {
			limit = {
				NOT = { has_country_flag = gor_vazumbrog_experienced_hunters }
				check_variable = { gorVazumbrogHuntsCompleted = 10 }
				check_variable = { gorVazumbrogArmyGolemCapacity = 1 }
			}
			country_event = { id = flavour_gor_vazumbrog.102 } #Experienced Hunters
		}
	}
}
